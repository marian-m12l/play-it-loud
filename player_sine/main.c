#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <ctype.h>
#include "pico/stdlib.h"
#include "pico/binary_info.h"

#include "gb_serial.h"

// Declare pins in binary info
bi_decl(bi_3pins_with_names(
    PIN_SERIAL_CLOCK, "GB Serial Clock",
    PIN_SERIAL_MISO, "GB Serial IN",
    PIN_SERIAL_MOSI, "GB Serial OUT"
));


#define SINE_WAVE_TABLE_LEN 2048
static int16_t sine_wave_table[SINE_WAVE_TABLE_LEN];
#define POLL_RATE_MS 5

// FIXME Builtin cover image
uint8_t cover_tiles[2704] = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xf8, 0xc7, 0xf8, 0xc1, 0xf8, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x78, 0x87, 0x20, 0xdf, 0x3b, 0xc4, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xfd, 0x02, 0xa0, 0x5f, 0xdc, 0x23, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x80, 0x7f, 0x80, 0x7f, 0xe7, 0x18, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x1f, 0xe0, 0x0f, 0xf7, 0x2f, 0xd0, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x07, 0xff, 0x6c, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xe0, 0xff, 0x3b, 0xff, 0x20, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xf7, 0x08, 0xe0, 0x1d, 0xf0, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x03, 0xff, 0x00, 0xff, 0x00, 0xc7, 0x38, 0x00, 0xf1, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x80, 0xff, 0x00, 0xff, 0x00, 0xf9, 0x06, 0x00, 0x77, 0x03, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xe3, 0x1f, 0x83, 0x7f, 0xfb, 0x07, 0xff, 0x03, 0x0f, 0xd3, 0x0f, 0xf3, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xc1, 0xfe, 0xc0, 0xff, 0xff, 0xc0, 0xdf, 0xe0, 0xff, 0x02, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x08, 0xf7, 0x00, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x20, 0xdf, 0xff, 0x00, 0xff, 0xf6, 0xff, 0x07, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x02, 0xfd, 0xff, 0x00, 0xff, 0x1b, 0xff, 0xdf, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x3e, 0xc1, 0xff, 0x00, 0xff, 0xfc, 0xff, 0xff, 0xff, 0x07, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xfc, 0xff, 0x39, 0xff, 0xe3, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xe0, 0xff, 0x20, 0xff, 0xf8, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x7d, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x7f, 0x80, 0xff, 0x00, 0xff, 0x00, 0xff, 0xe0, 0xff, 0x80, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xef, 0x10, 0xff, 0x00, 0xdf, 0x20, 0x3f, 0xc0, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xef, 0x10, 0xff, 0x00, 0xff, 0x00, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0xc3, 0xfc, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xcf, 0xf0, 0xff, 0xc0, 0xff, 0x00, 0xff, 0x00, 0xcd, 0x32, 0xf8, 0x07, 0x6f, 0x90, 0xdf, 0x20, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x7f, 0x80, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x03, 0xff, 0x03, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xa0, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x0c, 0xff, 0x03, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xf8, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x04, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x08, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x02, 0xff, 0x00, 0xff, 0x02, 0xff, 0x00, 0xff, 0x00, 0xff, 0x02, 0xff, 0x00, 0xff, 0x00, 0xff, 0x01, 0xff, 0x1e, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xa0, 0xff, 0x0f, 0xff, 0x92, 0xff, 0x21, 0xff, 0x01, 0xff, 0x18, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x40, 0xff, 0x00, 0xff, 0xe0, 0xff, 0x82, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xc0, 0xff, 0x00, 0xff, 0x18, 0xff, 0x06, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xc0, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x04, 0xff, 0x04, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x10, 0xbf, 0x48, 0xff, 0x00, 0xff, 0x10, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x07, 0xff, 0x03, 0xff, 0x03, 0xff, 0x0f, 0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc3, 0xff, 0xc0, 0xff, 0x01, 0xff, 0x00, 0xff, 0x00, 0xff, 0x03, 0xff, 0x03, 0xff, 0x00, 0xff, 0x80, 0xff, 0x00, 0xff, 0xfc, 0xff, 0x00, 0xff, 0x38, 0xff, 0x18, 0xff, 0x00, 0xff, 0x1a, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x1b, 0xff, 0x23, 0xff, 0x00, 0xff, 0x00, 0xff, 0x01, 0xff, 0xe1, 0xff, 0x6f, 0xff, 0x00, 0xff, 0xfe, 0xff, 0xff, 0xff, 0xfc, 0xff, 0x00, 0xff, 0x00, 0xff, 0xf0, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xc0, 0xff, 0xc4, 0xff, 0x3a, 0xff, 0x07, 0xff, 0x25, 0xff, 0xc5, 0xff, 0xd0, 0xff, 0x83, 0xff, 0xc0, 0xff, 0x04, 0xff, 0x00, 0xff, 0xde, 0xff, 0x81, 0xff, 0xe7, 0xff, 0x00, 0xff, 0xa0, 0xff, 0x00, 0xff, 0x80, 0xff, 0x15, 0xff, 0x10, 0xff, 0x07, 0xff, 0x78, 0xff, 0x00, 0xff, 0x00, 0xff, 0x09, 0xff, 0x00, 0xff, 0x00, 0xff, 0x32, 0xff, 0xfc, 0xff, 0x80, 0xff, 0x00, 0xff, 0x00, 0xff, 0xf0, 0xff, 0x07, 0xff, 0x07, 0xff, 0x20, 0xff, 0x18, 0xff, 0x01, 0xff, 0x00, 0xff, 0x00, 0xff, 0x10, 0xff, 0xe6, 0xff, 0x0e, 0xff, 0xce, 0xff, 0x08, 0xff, 0x00, 0xff, 0x00, 0xff, 0x04, 0xff, 0x00, 0xff, 0x1f, 0xff, 0xff, 0xff, 0x01, 0xff, 0x00, 0xff, 0x00, 0xff, 0x03, 0xff, 0x7f, 0xff, 0x07, 0xff, 0x87, 0xff, 0xf3, 0xff, 0xff, 0xff, 0x63, 0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xe8, 0xff, 0xfd, 0xff, 0xfe, 0xff, 0xe3, 0xff, 0xc9, 0xff, 0x00, 0xff, 0x00, 0xff, 0x18, 0xff, 0x18, 0xff, 0xc0, 0xff, 0x68, 0xff, 0x78, 0xff, 0x39, 0xff, 0x08, 0xff, 0x00, 0xff, 0xe0, 0xff, 0x1c, 0xff, 0xbf, 0xff, 0xff, 0xff, 0xf9, 0xff, 0xe0, 0xff, 0x00, 0xff, 0xc0, 0xff, 0x47, 0xff, 0x47, 0xff, 0xc7, 0xff, 0xc6, 0xff, 0xc6, 0xff, 0x41, 0xff, 0x7f, 0xff, 0xc1, 0xf9, 0xd6, 0xec, 0xd3, 0xe4, 0xdb, 0xe0, 0xdf, 0xff, 0x64, 0xf6, 0x09, 0xff, 0xfc, 0xff, 0xff, 0xff, 0x04, 0x7f, 0x84, 0xff, 0x05, 0x7f, 0x9f, 0xff, 0x7f, 0x7f, 0x80, 0xff, 0x80, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0xf2, 0xff, 0xfe, 0xff, 0xff, 0xff, 0x00, 0xff, 0x0f, 0xff, 0xff, 0xff, 0x40, 0xff, 0x40, 0xff, 0x40, 0xf7, 0x49, 0xff, 0x60, 0xff, 0x40, 0xff, 0x90, 0xff, 0xc7, 0xff, 0x47, 0xff, 0x07, 0xff, 0xfd, 0xff, 0x38, 0xff, 0x0e, 0xff, 0x8f, 0xff, 0x82, 0xff, 0xa0, 0xff, 0x88, 0xff, 0x88, 0xff, 0x8e, 0xff, 0x8e, 0xff, 0x50, 0x7f, 0xb3, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x01, 0xff, 0x00, 0xff, 0x29, 0xff, 0x3f, 0xff, 0x00, 0xff, 0xd8, 0xff, 0x80, 0xff, 0x00, 0xff, 0x80, 0xff, 0x07, 0xff, 0x06, 0xff, 0x30, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x23, 0xff, 0x03, 0xff, 0x7f, 0xff, 0xde, 0xff, 0xec, 0xff, 0xcf, 0xff, 0xc0, 0xe0, 0xdf, 0xe0, 0xdf, 0xff, 0xc5, 0xff, 0xfc, 0xff, 0xee, 0xff, 0x5f, 0xff, 0x14, 0xe7, 0x18, 0x0f, 0xf7, 0x7f, 0x8f, 0xff, 0xfd, 0xff, 0x38, 0xff, 0xe9, 0xff, 0xfc, 0xff, 0x66, 0xff, 0x7f, 0xff, 0x7e, 0xfc, 0xba, 0xf0, 0xe8, 0xc0, 0x20, 0xf8, 0x47, 0xf0, 0x4f, 0x40, 0xb2, 0xc0, 0xa0, 0x00, 0x80, 0x00, 0x03, 0x03, 0x04, 0x07, 0x18, 0x07, 0xf8, 0x0f, 0xf7, 0x0f, 0x17, 0x3f, 0x40, 0x7f, 0x80, 0xff, 0x01, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xcf, 0xff, 0xc8, 0xff, 0x01, 0xff, 0xf0, 0xff, 0x90, 0xff, 0x3c, 0xf8, 0x07, 0xff, 0xff, 0xff, 0x80, 0xff, 0x00, 0xff, 0x00, 0xf3, 0x0c, 0xef, 0x10, 0xff, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x18, 0xff, 0x03, 0xbf, 0x40, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x47, 0xbb, 0xff, 0xb3, 0xfc, 0x0a, 0xff, 0x82, 0xff, 0x01, 0xff, 0x00, 0xf0, 0x0f, 0xc0, 0x3f, 0xbf, 0x40, 0x80, 0xdf, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0xe0, 0x50, 0x70, 0xb8, 0x1c, 0xea, 0xbf, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x3f, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x9f, 0x0f, 0xf3, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x1b, 0x03, 0x0f, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xe0, 0xdf, 0xfc, 0xc3, 0xfc, 0xf2, 0xe0, 0xd0, 0xc0, 0xc0, 0xfe, 0xe1, 0xf8, 0xe6, 0xe0, 0x98, 0x00, 0xe0, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x80, 0x00, 0x00, 0x00, 0x01, 0x01, 0x06, 0x03, 0x0c, 0x0f, 0x30, 0x3f, 0x46, 0x7f, 0x8e, 0x1f, 0x20, 0x3f, 0xc0, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xfc, 0x03, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xfe, 0x01, 0xfc, 0x03, 0xff, 0x00, 0xff, 0x00, 0xfe, 0x01, 0xf9, 0x06, 0xd3, 0x2c, 0x07, 0xf8, 0x1f, 0xe0, 0x7f, 0x80, 0xff, 0x00, 0xff, 0x00, 0x7f, 0x80, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xe0, 0x1f, 0xf6, 0x09, 0xf2, 0x0d, 0xc0, 0x3f, 0xf8, 0x07, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x00, 0xff, 0x01, 0xfe, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xfe, 0x01, 0xe0, 0x1f, 0x0f, 0xf6, 0xff, 0x03, 0xff, 0x00, 0x0f, 0xf0, 0x03, 0xfc, 0x03, 0xfc, 0x00, 0xff, 0xf0, 0x0f, 0x00, 0x80, 0x80, 0xc0, 0xe0, 0xd0, 0xf8, 0x74, 0xfc, 0x1e, 0xff, 0x0e, 0xff, 0x03, 0x3f, 0xc1, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xa0, 0xe0, 0xd0, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc4, 0xc1, 0xc6, 0xc3, 0xcc, 0xc7, 0xd8, 0x00, 0x03, 0x03, 0x0c, 0x0f, 0x10, 0x3f, 0x42, 0x3f, 0xc2, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x3e, 0xff, 0x20, 0xff, 0x00, 0xff, 0x80, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xf9, 0x06, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xdf, 0x20, 0x9f, 0x60, 0xff, 0x00, 0xff, 0x00, 0xe7, 0x18, 0xf8, 0x07, 0xfc, 0x03, 0xf9, 0x06, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xf3, 0x0c, 0xf7, 0x08, 0x7f, 0x80, 0x0f, 0xf0, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xf0, 0x0f, 0x83, 0x7c, 0x87, 0x78, 0x87, 0x78, 0xcf, 0x30, 0xcf, 0x30, 0xc7, 0x38, 0x87, 0x78, 0x0f, 0xf0, 0xf0, 0x0f, 0xe0, 0x1f, 0xf8, 0x07, 0xf8, 0x07, 0xf8, 0x07, 0xfc, 0x03, 0xfc, 0x03, 0xfc, 0x03, 0x0f, 0xf0, 0x07, 0xf8, 0x07, 0xf8, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xf8, 0xf4, 0xfe, 0x3c, 0xff, 0x1e, 0x7f, 0x87, 0x1f, 0xe3, 0x07, 0xf8, 0x00, 0xff, 0x00, 0xff, 0x03, 0x03, 0x03, 0x03, 0x03, 0x83, 0xc3, 0xa3, 0xe3, 0xf3, 0xfb, 0xf7, 0xff, 0x7f, 0x3f, 0xdf, 0xdf, 0xe0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xd8, 0xff, 0xc0, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xe1, 0x1e, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xe7, 0x18, 0xa7, 0x58, 0xe7, 0x18, 0xff, 0x00, 0xfe, 0x01, 0xf8, 0x07, 0xf3, 0x0c, 0xff, 0x00, 0xff, 0x00, 0xe7, 0x18, 0xe7, 0x18, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x20, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xf0, 0x0f, 0xe1, 0x1e, 0xc0, 0x3f, 0x87, 0x78, 0xcf, 0x30, 0xff, 0x00, 0xff, 0x00, 0xfc, 0x03, 0x0f, 0xf0, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x1f, 0xe0, 0xf8, 0x07, 0xe0, 0x1f, 0x80, 0x7f, 0x00, 0xff, 0x80, 0x7f, 0x80, 0x7f, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x02, 0xfd, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x10, 0xef, 0x03, 0xfc, 0x0f, 0xf0, 0x0f, 0xf0, 0x1f, 0xef, 0x07, 0xfb, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0xc3, 0x3f, 0xff, 0x03, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0xc0, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xfe, 0x01, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x8f, 0x70, 0x0f, 0xf0, 0x03, 0xfc, 0x03, 0xfc, 0xff, 0x00, 0xff, 0x00, 0xfc, 0x03, 0xfc, 0x03, 0xfc, 0x03, 0xff, 0x00, 0xff, 0x00, 0xfc, 0x03, 0xf8, 0x07, 0xf8, 0x07, 0x10, 0xef, 0x00, 0xff, 0xc0, 0x3f, 0xe0, 0x1f, 0xe0, 0x1f, 0x73, 0x8c, 0x3e, 0xc1, 0x38, 0xc7, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x03, 0xfc, 0x1f, 0xe0, 0xff, 0x00, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x71, 0x8e, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0x04, 0xfb, 0x0f, 0xf0, 0x0f, 0xf0, 0x37, 0xc8, 0xfb, 0x04, 0xc3, 0x3c, 0x83, 0x7c, 0x02, 0xfd, 0x3f, 0xc0, 0xff, 0x00, 0x9f, 0x60, 0xcf, 0x30, 0xcf, 0x30, 0xc7, 0x38, 0x0f, 0xf0, 0x0f, 0xf0, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x03, 0xff, 0x2f, 0xff, 0xc0, 0xff, 0xc0, 0xc0, 0xff, 0xc0, 0xff, 0xd1, 0xee, 0xc3, 0xfc, 0xc2, 0xfd, 0xc4, 0xfb, 0xff, 0x00, 0xff, 0x00, 0x46, 0xb9, 0x85, 0x7a, 0x8f, 0x70, 0x1b, 0xe4, 0x13, 0xec, 0x3f, 0xc0, 0xff, 0x00, 0xff, 0x00, 0xeb, 0x14, 0xe3, 0x1c, 0x43, 0xbc, 0xe7, 0x18, 0xbf, 0x40, 0x9f, 0x60, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xef, 0x10, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xef, 0x10, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xf8, 0x07, 0xfc, 0x03, 0xfc, 0x03, 0xfe, 0x01, 0xf4, 0x0b, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xfc, 0x03, 0xc6, 0x39, 0x66, 0x99, 0x77, 0x88, 0x23, 0xdc, 0x3f, 0xc0, 0x87, 0x78, 0xc7, 0x38, 0x66, 0x99, 0x63, 0x9c, 0x31, 0xce, 0x91, 0x6e, 0x18, 0xe7, 0x8c, 0x73, 0x1f, 0xe0, 0x66, 0x99, 0x21, 0xde, 0x31, 0xce, 0x18, 0xe7, 0x8c, 0x73, 0xc4, 0x3b, 0x42, 0xbd, 0xff, 0x03, 0x23, 0xdf, 0x33, 0xcf, 0x8b, 0x77, 0x83, 0x7f, 0x43, 0xbf, 0x63, 0x9f, 0x23, 0xdf, 0xcc, 0xf3, 0xd0, 0xef, 0xd0, 0xef, 0xe1, 0xde, 0xc3, 0xfc, 0xc3, 0xfc, 0xff, 0xff, 0xff, 0xff, 0x6f, 0x90, 0xce, 0x31, 0xcf, 0x30, 0xfc, 0x03, 0x3c, 0xc3, 0x78, 0x87, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xc0, 0xbf, 0x40, 0xbf, 0x40, 0x7f, 0x80, 0xff, 0x00, 0x7f, 0x80, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xdf, 0x20, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xf7, 0x08, 0xf7, 0x08, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0x7e, 0x81, 0xfe, 0x01, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0x17, 0xe8, 0x18, 0xe7, 0x18, 0xe7, 0x8c, 0x73, 0x8e, 0x71, 0x84, 0x7b, 0xff, 0xff, 0xff, 0xff, 0x8c, 0x73, 0xc6, 0x39, 0x42, 0xbd, 0x63, 0x9c, 0x21, 0xde, 0xb1, 0x4e, 0xff, 0xff, 0xff, 0xff, 0x63, 0x9c, 0x31, 0xce, 0x10, 0xef, 0x18, 0xe7, 0xac, 0x53, 0x86, 0x79, 0xff, 0xff, 0xff, 0xff, 0x13, 0xef, 0x87, 0x7b, 0xc7, 0x3b, 0x43, 0xbf, 0x63, 0x9f, 0x33, 0xcf, 0xff, 0xff, 0xff, 0xff
};
char* artist = "Sine #            ";
char* title = "Swiping frequency ";
char metadata[36];

int counter = 0;

void send_cover_and_metadata() {
    // TODO Must send cover tiles and metadata now
    // TODO Use this firmware to iron out chnage of track ??

    // FIXME Immediate transfers KO ???
    // TODO Measure transfer time ?

    printf("[%llu] Tranferring cover: start transfer of 2704 bytes\n", time_us_64());
    gb_serial_immediate_transfer(cover_tiles, 2704);
    while (!gb_serial_transfer_done()) {
        tight_loop_contents();
    }
    printf("[%llu] Cover transferred: start transfer of 36 bytes of metadata (artist: %s)(track: %s)\n", time_us_64(), artist, title);

    // FIXME Shouldn't be needed, DMA should self-deinit when transfer is done (wit hirq handler ?)
    //gb_serial_stop(false);
    
    // Characters must be uppercased and shifted -0x20 because char tiles are available as 0x00-0x3f (mapped to 0x20-0x5f ascii)
    memcpy(metadata, artist, 18);
    memcpy(&metadata[18], title, 18);
    metadata[6] = '0' + counter++;
    printf("metadata: %s\n", metadata);
    for (int i=0; i<36; i++) {
        metadata[i] = toupper(metadata[i]) - 0x20;
    }
    printf("[%llu] Tranferring metadata: start transfer of 36 bytes\n", time_us_64());
    gb_serial_immediate_transfer(metadata, 36);
    while (!gb_serial_transfer_done()) {
        tight_loop_contents();
    }
    printf("[%llu] Metadata transferred: start audio samples DMA\n", time_us_64());
        
    // FIXME Shouldn't be needed, DMA should self-deinit when transfer is done (wit hirq handler ?)
    //gb_serial_stop(false);
}

int main() {
    stdio_init_all();

    sleep_ms(5000);

    printf("Sine Wave Player\n");

    // Prepare sine samples
    for (int i = 0; i < SINE_WAVE_TABLE_LEN; i++) {
        sine_wave_table[i] = 32767 * cosf(i * 2 * (float) (M_PI / SINE_WAVE_TABLE_LEN));
    }
    uint32_t step = 0x400000;
    uint32_t pos = 0;
    uint32_t pos_max = 0x10000 * SINE_WAVE_TABLE_LEN;
    uint vol = 128;

    // TODO Simplify gb_serial --> init (pio + dma + isr) ; immediate transfer ; start stream ; stop stream

    // Configure audio playback
    gb_serial_init();

    send_cover_and_metadata();

    // Start streaming
    gb_serial_streaming_start();

    while (true) {
        int expected;
        while (expected = gb_serial_streaming_needs_samples()) {
            int16_t *samples = malloc(sizeof(int16_t) * expected);
            for (uint i = 0; i < expected; i++) {
                samples[i] = (vol * sine_wave_table[pos >> 16u]) >> 8u;
                pos += step;
                if (pos >= pos_max) pos -= pos_max;
            }
            step = (step + 0x1000) % 0x1000000;
            gb_serial_streaming_fill_buffer(samples);
            free(samples);
        }
        sleep_ms(POLL_RATE_MS);

        // TODO Send new cover after a given delay ?
        if ((time_us_64() % 10000000) < 10000) {
            printf("[%llu] Changing track\n", time_us_64());
            gb_serial_streaming_stop();

            // FIXME KO after audio stream ??
            uint8_t trigger = 0xf1;
            printf("[%llu] Tranferring reset trigger: start transfer of 1 byte\n", time_us_64());
            gb_serial_immediate_transfer(&trigger, 1);
            while (!gb_serial_transfer_done()) {
                tight_loop_contents();
            }
            printf("[%llu] Trigger transferred\n", time_us_64());
            // FIXME Shouldn't be needed, DMA should self-deinit when transfer is done (wit hirq handler ?)
            //gb_serial_stop(false);
            //sleep_ms(3000);
            sleep_ms(100);  // Do we need to sleep while the gb resets?
            printf("[%llu] Send new cover\n", time_us_64());
            send_cover_and_metadata();
            printf("[%llu] Stream audio\n", time_us_64());
            gb_serial_streaming_start();
        }
    }
}